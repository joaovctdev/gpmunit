<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA GEST√ÉO GPM MARIU√Å</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", sans-serif; background: #1a1a1a; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; }
        .admin-panel { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .upload-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .file-label { background: #444; color: white; padding: 12px; border-radius: 8px; cursor: pointer; display: block; font-weight: bold; font-size: 11px; }
        input[type="file"] { display: none; }
        .status-txt { font-size: 11px; color: #888; margin-top: 5px; display: block; }
        .btn-group { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; padding-top: 15px; border-top: 1px solid #eee; }
        .btn { padding: 12px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; text-transform: uppercase; color: white; }
        .btn-hoje { background: #27ae60; } 
        .btn-rdo { background: #1565c0; } 
        .btn-apr { background: #7b1fa2; }
        .btn-turno { background: #d35400; }
        .btn-ontem { background: #555; }
        .btn-png { background: #333; margin-top: 10px; width: 100%; }
        .report-area { background: white; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .report-header { background: #00b7ab; color: white; padding: 25px; text-align: center; border-bottom: 6px solid #ffc107; }
        .report-body { padding: 25px; min-height: 400px; }
        .section-title { margin: 20px 0 10px; padding: 10px; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; font-weight: bold; background: #f9f9f9; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; }
        .card { padding: 12px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 11px; font-weight: bold; border: 1px solid #eee; }
        .bg-verde { background: #e8f5e9; border-left: 8px solid #2e7d32; color: #1b5e20; }
        .bg-laranja { background: #fff3e0; border-left: 8px solid #ef6c00; color: #e65100; }
        .bg-vermelho { background: #ffebee; border-left: 8px solid #c62828; color: #b71c1c; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 9px; }
    </style>
</head>
<body>

<div class="container">
    <div class="admin-panel">
        <div class="upload-row">
            <div><label class="file-label" for="fT">üìÇ TURNO (XLSX)</label><input type="file" id="fT"><span id="sT" class="status-txt">Pendente</span></div>
            <div><label class="file-label" for="fS" style="background:#1565c0">üìÇ RDO / FATUR. (CSV/XLSX)</label><input type="file" id="fS"><span id="sS" class="status-txt">Pendente</span></div>
            <div><label class="file-label" for="fA" style="background:#7b1fa2">üìÇ APR (XLSX)</label><input type="file" id="fA"><span id="sA" class="status-txt">Pendente</span></div>
        </div>
        <div class="btn-group">
            <button class="btn btn-hoje" onclick="processar('hoje')">Turno Hoje</button>
            <button class="btn btn-ontem" onclick="processar('rdo-ontem')">RDO Ontem</button>
            <button class="btn btn-ontem" onclick="processar('apr-ontem')">APR Ontem</button>
            <button class="btn btn-rdo" onclick="processar('mensal-rdo')">üìë RDO Mensal (CSV)</button>
            <button class="btn btn-apr" onclick="processar('mensal-apr')">üìù APR Mensal</button>
            <button class="btn btn-turno" onclick="processar('mensal-turno')">üìä Turno Mensal</button>
            <button class="btn btn-png" id="btnPng" disabled onclick="baixarPNG()">üì∏ Baixar Foto PNG</button>
        </div>
    </div>

    <div class="report-area" id="printArea">
        <div class="report-header">
            <h1 id="tituloRel">SISTEMA DE GEST√ÉO GPM</h1>
            <p>RELAT√ìRIO: <span id="dataTxt">--/--/----</span></p>
        </div>
        <div class="report-body" id="renderArea">
            <p style="text-align:center; color:#999; margin-top:100px;">Importe as planilhas para gerar os indicadores.</p>
        </div>
    </div>
</div>

<script>
const EQUIPES = ["ALAN-IRC", "ALEX-IRC", "EDILSON-IRC", "EDMILSON-IRC", "ELIEZER-IRC", "ENES-IRC", "ESMERALDO-IRC", "FELIPE-IRC", "GABRIEL-IRC", "GIORLAN-IRC", "IRISMAR-IRC", "JAILSON-IRC", "JARBAS-IRC", "MARCOS-IRC", "MENEZES-IRC", "REVERTON-IRC", "RIAN-IRC", "ROMERO-IRC", "UBERDAN-IRC", "VANILSON-IRC", "WASHINGTON-IRC", "WESLEY-IRC", "WILIAN-IRC", "ANDRE-JAC", "CAIQUE-JAC", "CARLOS-JAC", "CLEBSON-JAC", "DIOGO-JAC", "DOUGLAS-JAC", "EMERSON-JAC", "FABIANO-JAC", "GERALDO-JAC", "JAILTON-JAC", "JAIR-JAC", "JOAO-JAC", "JULIO-JAC", "LUCIANO-JAC", "PATRICIO-JAC", "RODRIGO-JAC", "TIAGO-JAC", "VALMIR-JAC"].sort();

let db = { turno: [], rdo: [], apr: [] };

// LEITOR PARA XLSX E CSV (detecta separador automaticamente)
function leitor(idIn, idSt, key) {
    document.getElementById(idIn).onchange = e => {
        const file = e.target.files[0];
        const fileName = file.name.toLowerCase();
        const isCSV = fileName.endsWith('.csv');

        if (isCSV) {
            // L√™ CSV como texto para detectar separador
            const reader = new FileReader();
            reader.onload = ev => {
                const text = ev.target.result;
                // Detecta separador (ponto-e-v√≠rgula ou v√≠rgula)
                const firstLine = text.split('\n')[0];
                const separator = firstLine.includes(';') ? ';' : ',';
                const workbook = XLSX.read(text, {type: 'string', FS: separator});
                db[key] = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });
                console.log(`CSV carregado (${key}):`, db[key].length, 'linhas');
                console.log('Colunas:', Object.keys(db[key][0] || {}));
                document.getElementById(idSt).innerText = "‚úÖ Pronto (" + db[key].length + " linhas)";
                document.getElementById(idSt).style.color = "green";
            };
            reader.readAsText(file, 'UTF-8');
        } else {
            // L√™ XLSX normalmente
            const reader = new FileReader();
            reader.onload = ev => {
                const data = new Uint8Array(ev.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                db[key] = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });
                console.log(`XLSX carregado (${key}):`, db[key].length, 'linhas');
                document.getElementById(idSt).innerText = "‚úÖ Pronto (" + db[key].length + " linhas)";
                document.getElementById(idSt).style.color = "green";
            };
            reader.readAsArrayBuffer(file);
        }
    };
}

leitor('fT', 'sT', 'turno'); leitor('fS', 'sS', 'rdo'); leitor('fA', 'sA', 'apr');

function extrairEquipe(row) {
    // Prioriza des_equipe (nome) sobre cod_equipe (c√≥digo num√©rico)
    for(let k in row) {
        let key = k.toLowerCase();
        if(key.includes('des_equipe') || key === 'des_equipe' || key === 'equipe') {
            return String(row[k]).toUpperCase().trim();
        }
    }
    // Se n√£o encontrou des_equipe, procura qualquer coluna com "equipe" que n√£o seja c√≥digo
    for(let k in row) {
        let key = k.toLowerCase();
        if(key.includes('equipe') && !key.includes('cod')) {
            return String(row[k]).toUpperCase().trim();
        }
    }
    // Fallback: qualquer coluna com equipe
    for(let k in row) {
        if(k.toLowerCase().includes('equipe')) {
            let val = String(row[k]).toUpperCase().trim();
            // Se for texto (cont√©m letras), retorna
            if(/[A-Z]/.test(val)) return val;
        }
    }
    return "";
}

function extrairData(row) {
    for(let k in row) {
        if(k.toLowerCase().includes('data')) {
            return String(row[k]);
        }
    }
    return "";
}

function extrairDataInicio(row) {
    for(let k in row) {
        let key = k.toLowerCase().replace(/_/g, '').trim();
        if(key.includes('datainicio') || key.includes('inicio')) {
            return String(row[k]);
        }
    }
    return "";
}

function processar(modo) {
    const area = document.getElementById('renderArea');
    const hoje = new Date();
    const ontem = new Date(); ontem.setDate(hoje.getDate() - 1);
    const dHoje = hoje.toLocaleDateString('pt-BR');
    const dOntem = ontem.toLocaleDateString('pt-BR');
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();

    let cont = {}; EQUIPES.forEach(e => cont[e] = 0);

    // 1. TURNO HOJE - L√™ TURNO HOJE.xlsx e mostra quem abriu e n√£o abriu
    if (modo === 'hoje') {
        document.getElementById('tituloRel').innerText = "TURNO HOJE (" + dHoje + ")";
        let ativos = new Set();
        db.turno.forEach(r => {
            let eq = extrairEquipe(r);
            if(EQUIPES.includes(eq)) ativos.add(eq);
        });
        const ok = EQUIPES.filter(e => ativos.has(e));
        const falta = EQUIPES.filter(e => !ativos.has(e));
        area.innerHTML = desenhar("‚úÖ ABRIU TURNO", ok, "bg-verde", "OK", "#2e7d32") +
                         desenhar("üî¥ N√ÉO ABRIU TURNO", falta, "bg-vermelho", "FALTA", "#c62828");
    }

    // 2. RDO ONTEM - Compara turno com RDO: quem abriu turno e fez RDO, quem abriu mas n√£o fez, quem nem abriu
    else if (modo === 'rdo-ontem') {
        document.getElementById('tituloRel').innerText = `RDO ONTEM (${dOntem})`;

        let turnoSet = new Set();
        let rdoSet = new Set();

        // Equipes que abriram turno (da planilha TURNO)
        db.turno.forEach(r => {
            let eq = extrairEquipe(r);
            if(EQUIPES.includes(eq)) turnoSet.add(eq);
        });

        // Equipes que fizeram RDO (da planilha RDO)
        db.rdo.forEach(r => {
            let eq = extrairEquipe(r);
            if(EQUIPES.includes(eq)) rdoSet.add(eq);
        });

        const abriuEFezRdo = EQUIPES.filter(e => turnoSet.has(e) && rdoSet.has(e));
        const abriuMasNaoFezRdo = EQUIPES.filter(e => turnoSet.has(e) && !rdoSet.has(e));
        const naoAbriuTurno = EQUIPES.filter(e => !turnoSet.has(e));

        area.innerHTML = desenhar("‚úÖ ABRIU TURNO + FEZ RDO", abriuEFezRdo, "bg-verde", "OK", "#2e7d32") +
                         desenhar("üî¥ ABRIU TURNO + SEM RDO", abriuMasNaoFezRdo, "bg-vermelho", "PENDENTE", "#c62828") +
                         desenhar("‚ö†Ô∏è N√ÉO ABRIU TURNO", naoAbriuTurno, "bg-laranja", "S/ TURNO", "#ef6c00");
    }

    // 3. APR ONTEM - Compara turno com RDO e APR
    else if (modo === 'apr-ontem') {
        document.getElementById('tituloRel').innerText = `APR ONTEM (${dOntem})`;

        let turnoSet = new Set();
        let rdoSet = new Set();
        let aprSet = new Set();

        // Equipes que abriram turno
        db.turno.forEach(r => {
            let eq = extrairEquipe(r);
            if(EQUIPES.includes(eq)) turnoSet.add(eq);
        });

        // Equipes que fizeram RDO
        db.rdo.forEach(r => {
            let eq = extrairEquipe(r);
            if(EQUIPES.includes(eq)) rdoSet.add(eq);
        });

        // Equipes que fizeram APR
        db.apr.forEach(r => {
            let eq = extrairEquipe(r);
            if(EQUIPES.includes(eq)) aprSet.add(eq);
        });

        const fezRdoEApr = EQUIPES.filter(e => rdoSet.has(e) && aprSet.has(e));
        const fezRdoSemApr = EQUIPES.filter(e => rdoSet.has(e) && !aprSet.has(e));
        const naoAbriuTurno = EQUIPES.filter(e => !turnoSet.has(e));

        area.innerHTML = desenhar("‚úÖ FEZ RDO + APR", fezRdoEApr, "bg-verde", "OK", "#2e7d32") +
                         desenhar("üî¥ FEZ RDO SEM APR", fezRdoSemApr, "bg-vermelho", "S/ APR", "#c62828") +
                         desenhar("‚ö†Ô∏è N√ÉO ABRIU TURNO", naoAbriuTurno, "bg-laranja", "S/ TURNO", "#ef6c00");
    }

    // 4. TURNO MENSAL - Conta dias √∫nicos que cada equipe abriu turno (2 no mesmo dia = 1)
    else if (modo === 'mensal-turno') {
        document.getElementById('tituloRel').innerText = "TURNOS ABERTOS NO JUPITER - MENSAL";

        let diasPorEquipe = {};
        EQUIPES.forEach(e => diasPorEquipe[e] = new Set());

        db.turno.forEach(r => {
            let eq = extrairEquipe(r);
            let dt = extrairData(r);
            if(EQUIPES.includes(eq) && dt) {
                const partes = dt.split(' ')[0].split('/');
                if(partes.length === 3) {
                    const dia = partes[0];
                    const mes = parseInt(partes[1]) - 1;
                    const ano = partes[2].length === 2 ? 2000 + parseInt(partes[2]) : parseInt(partes[2]);
                    if(mes === mesAtual && ano === anoAtual) {
                        diasPorEquipe[eq].add(partes[0] + '/' + partes[1]);
                    }
                }
            }
        });

        EQUIPES.forEach(e => cont[e] = diasPorEquipe[e].size);
        renderRanking(cont, "DIAS", "turno");
    }

    // 5. RDO MENSAL - CSV, conta cod_serv √∫nicos por equipe
    // Ignora linhas onde data_inicio seja 07:00 ou 07:30
    else if (modo === 'mensal-rdo') {
        document.getElementById('tituloRel').innerText = "RDO REALIZADO NO JUPITER - MENSAL";

        // Fun√ß√£o para verificar se hora √© 07:00 ou 07:30
        function isHora0700ou0730(dataInicio) {
            if(!dataInicio) return false;
            let str = String(dataInicio);

            // Formato texto: "14/01/2026 07:30"
            if(str.includes(" 07:30") || str.includes(" 07:00")) return true;

            // Formato serial Excel: n√∫mero como "46143.31217592592"
            let num = parseFloat(str);
            if(!isNaN(num) && num > 40000) { // √â um n√∫mero serial do Excel
                let parteDecimal = num - Math.floor(num);
                // 07:00 = 7/24 = 0.291666...
                // 07:30 = 7.5/24 = 0.3125
                // Toler√¢ncia de 1 minuto = 1/(24*60) = 0.000694
                if(Math.abs(parteDecimal - 0.291666) < 0.001 || Math.abs(parteDecimal - 0.3125) < 0.001) {
                    return true;
                }
            }

            return false;
        }

        // Set para armazenar cod_serv √∫nicos por equipe
        let servicosPorEquipe = {};
        EQUIPES.forEach(e => servicosPorEquipe[e] = new Set());

        db.rdo.forEach(row => {
            let eq = extrairEquipe(row);
            let dataInicio = row['data_inicio'];
            let codServ = String(row['cod_serv'] || '');

            if(EQUIPES.includes(eq) && codServ) {
                // Ignora se hora √© 07:00 ou 07:30 (em qualquer formato)
                if(isHora0700ou0730(dataInicio)) return;

                // Adiciona cod_serv ao Set da equipe (evita duplicatas)
                servicosPorEquipe[eq].add(codServ);
            }
        });

        // Conta quantidade de servi√ßos √∫nicos por equipe
        EQUIPES.forEach(e => cont[e] = servicosPorEquipe[e].size);

        console.log("Servi√ßos √∫nicos por equipe:", cont);
        console.log("JAILSON-IRC:", cont['JAILSON-IRC']);
        renderRanking(cont, "RDOs", "rdo");
    }

    // 6. APR MENSAL - Conta todos os registros mesmo que m√∫ltiplos no dia
    else if (modo === 'mensal-apr') {
        document.getElementById('tituloRel').innerText = "APR ENVIADAS NO JUPITER - MENSAL";

        db.apr.forEach(r => {
            let eq = extrairEquipe(r);
            let dt = extrairData(r);
            if(EQUIPES.includes(eq) && dt) {
                const partes = dt.split(' ')[0].split('/');
                if(partes.length === 3) {
                    const mes = parseInt(partes[1]) - 1;
                    const ano = partes[2].length === 2 ? 2000 + parseInt(partes[2]) : parseInt(partes[2]);
                    if(mes === mesAtual && ano === anoAtual) {
                        cont[eq]++;
                    }
                }
            }
        });
        renderRanking(cont, "APRs", "apr");
    }

    document.getElementById('dataTxt').innerText = dHoje;
    document.getElementById('btnPng').disabled = false;
}

function renderRanking(dados, suf, tipo) {
    const lista = EQUIPES.map(e => [e, dados[e]]).sort((a,b) => b[1] - a[1]);
    let html = `<div class="grid">`;
    lista.forEach(([eq, q]) => {
        let cor = "bg-verde"; let bC = "#2e7d32";
        if(tipo === 'apr') {
            if(q < 3) { cor = "bg-vermelho"; bC = "#c62828"; }
            else if(q < 10) { cor = "bg-laranja"; bC = "#ef6c00"; }
        } else {
            if(q <= 10) { cor = "bg-vermelho"; bC = "#c62828"; }
            else if(q <= 15) { cor = "bg-laranja"; bC = "#ef6c00"; }
        }
        html += `<div class="card ${cor}"><span>${eq}</span><span class="badge" style="background:${bC}">${q} ${suf}</span></div>`;
    });
    document.getElementById('renderArea').innerHTML = html + "</div>";
}

function desenhar(t, l, c, b, cor) {
    const cards = l.map(n => `<div class="card ${c}"><span>${n}</span><span class="badge" style="background:${cor}">${b}</span></div>`).join('');
    return `<div class="section-title"><span>${t}</span> <span>${l.length}</span></div><div class="grid">${cards}</div>`;
}

function baixarPNG() {
    html2canvas(document.getElementById('printArea')).then(canvas => {
        const link = document.createElement('a');
        link.download = 'relatorio_gpm.png';
        link.href = canvas.toDataURL();
        link.click();
    });
}
</script>
</body>
</html>