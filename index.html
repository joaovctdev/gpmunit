<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDO - Controle Operacional XLSX</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", sans-serif; background: #1a1a1a; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; }
        .admin-panel { background: #fff; padding: 25px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .upload-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .file-label { background: #004d40; color: white; padding: 15px; border-radius: 8px; cursor: pointer; display: block; font-weight: bold; transition: 0.3s; }
        .file-label:hover { background: #00695c; }
        input[type="file"] { display: none; }
        .btn-group { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .btn { padding: 14px 28px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; text-transform: uppercase; }
        .btn-today { background: #2e7d32; color: white; }
        .btn-rdo { background: #1565c0; color: white; }
        .btn-png { background: #333; color: white; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .report-area { background: white; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .report-header { background: #00b7ab; color: white; padding: 30px; text-align: center; border-bottom: 6px solid #ffc107; }
        .report-header h1 { font-size: 22px; margin-bottom: 5px; }
        .report-body { padding: 30px; min-height: 400px; }
        .section-title { margin: 25px 0 10px; padding-bottom: 8px; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; font-weight: bold; color: #555; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 10px; }
        .card { padding: 12px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 11px; font-weight: bold; border: 1px solid #eee; }
        .bg-verde { background: #e8f5e9; border-left: 8px solid #2e7d32; color: #1b5e20; }
        .bg-laranja { background: #fff3e0; border-left: 8px solid #ef6c00; color: #e65100; }
        .bg-vermelho { background: #ffebee; border-left: 8px solid #c62828; color: #b71c1c; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 9px; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="container">
    <div class="admin-panel">
        <div class="upload-row">
            <div>
                <label class="file-label" for="fileTurno">ðŸ“‚ CARREGAR TURNO (.xlsx)</label>
                <input type="file" id="fileTurno" accept=".xlsx">
                <p id="nameT" style="font-size: 12px; margin-top: 5px; color: #666;">Nenhum arquivo</p>
            </div>
            <div>
                <label class="file-label" for="fileServico" style="background: #3949ab;">ðŸ“‚ CARREGAR SERVIÃ‡OS (.xlsx)</label>
                <input type="file" id="fileServico" accept=".xlsx">
                <p id="nameS" style="font-size: 12px; margin-top: 5px; color: #666;">Opcional para Turno Hoje</p>
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-today" id="btnHoje">ðŸ“… TURNO HOJE</button>
            <button class="btn btn-rdo" id="btnRdo">ðŸ“Š RDO (ONTEM)</button>
            <button class="btn btn-png" id="btnPng" disabled>ðŸ“¸ BAIXAR PNG</button>
        </div>
    </div>

    <div class="report-area" id="printArea">
        <div class="report-header">
            <h1 id="tituloRel">RELATÃ“RIO OPERACIONAL</h1>
            <p>DATA: <span id="dataTxt">--/--/----</span></p>
        </div>
        <div class="report-body" id="renderArea">
            <p style="text-align:center; color:#999; margin-top:100px;">Carregue os arquivos e escolha o relatÃ³rio acima.</p>
        </div>
    </div>
</div>

<script>
const EQUIPES = {
        // === BASE IRECÃŠ (IRC) ===
        "ALAN-IRC":      "ALAN NUNES BARRETO",
        "ALEX-IRC":      "ALEX SANDRO SANTOS BISPO",
        "EDILSON-IRC":   "EDILSON DE SOUZA SANTOS",
        "EDMILSON-IRC":  "EDMILSON RIBEIRO DO NASCIMENTO",
        "ELIEZER-IRC":   "ELIEZER BATISTA",
        "ENES-IRC":      "ENES RAMOS DA SILVA",
        "ESMERALDO-IRC": "ESMERALDO DOS SANTOS OLIVEIRA",
        "FELIPE-IRC":    "FELIPE PEREIRA ALVES",
        "GABRIEL-IRC":   "GABRIEL DOS SANTOS SILVA",
        "GIORLAN-IRC":   "GIORLAN EVANGELISTA SOUZA",
        "IRISMAR-IRC":   "IRISMAR MARQUES SILVA",
        "JAILSON-IRC":   "JAILSON SANTOS SILVA",
        "JARBAS-IRC":    "JARBAS SOUZA AMORIM",
        "MARCOS-IRC":    "MARCOS PAULO CARDOSO",
        "MENEZES-IRC":   "VANDERLEI DE MENEZES SEVERO",
        "REVERTON-IRC":  "REVERTON BASTOS ROCHA NOVAIS",
        "RIAN-IRC":      "RIAN LUCAS FERREIRA OLIVEIRA",
        "ROMERO-IRC":    "ROMERO DIAS SILVA",
        "UBERDAN-IRC":   "UBERDAN CERQUEIRA DA SILVA",
        // "VAGNO-IRC":     "VAGNO SILVA NOVAIS",
        "VANILSON-IRC":  "VANILSON LUCIO DOS SANTOS SILVA",
        "WASHINGTON-IRC":"WASHINGTON ALVES OLIVEIRA",
        "WESLEY-IRC":    "WESLEY REIS DE OLIVEIRA",
        "WILIAN-IRC":    "WILIAN DA SILVA SENA",

        // === BASE JACOBINA (JAC) ===
        "ANDRE-JAC":     "CARLOS ANDRE SANTOS DA SILVA",
        "CAIQUE-JAC":    "CAIQUE SILVA LIMA",
        "CARLOS-JAC":    "CARLOS DA CRUZ SANTANA",
        "CLEBSON-JAC":   "CLEBSON REIS NETO",
        "DIOGO-JAC":     "DIOGO CRUZ DOS SANTOS",
        "DOUGLAS-JAC":   "DOUGLAS DA SILVA MELO",
        "EMERSON-JAC":   "EMERSON DE CARVALHO SILVA",
        "FABIANO-JAC":   "FABIANO LOPES DE MORAES",
        // "FERNANDO-JAC":  "AMILTON FERNANDO ALVES COSTA",
        "GERALDO-JAC":   "GERALDO DA COSTA GOMES",
        "JAILTON-JAC":   "JAILTON DA SILVA",
        "JAIR-JAC":      "JAIR DE JESUS",
        // "JENILSON-JAC":  "ABNER VICENTE FONSECA",
        "JOAO-JAC":      "JOAO PEREIRA DA SILVA",
        "JULIO-JAC":     "JULIO SERAFIM DAMACENO DOS SANTOS",
        "LUCIANO-JAC":   "LUCIANO NUNES DA SILVA",
        // "OSIMAR-JAC":    "OSIMAR OLIVEIRA SOUZA",
        "PATRICIO-JAC":  "PATRICIO DA SILVA BARBOSA",
        "RODRIGO-JAC":   "RODRIGO SANTOS SILVA",
        "TIAGO-JAC":     "TIAGO BARBOZA DE SOUZA",
        "VALMIR-JAC":    "VALMIR ALVES DA SILVA"
      };

let baseT = [], baseS = [];

// Leitores de Arquivo
document.getElementById('fileTurno').onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => {
        const wb = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
        baseT = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        document.getElementById('nameT').innerText = "âœ… Carregado";
    };
    reader.readAsArrayBuffer(e.target.files[0]);
};

document.getElementById('fileServico').onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => {
        const wb = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
        baseS = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        document.getElementById('nameS').innerText = "âœ… Carregado";
    };
    reader.readAsArrayBuffer(e.target.files[0]);
};

document.getElementById('btnHoje').onclick = () => processar('hoje');
document.getElementById('btnRdo').onclick = () => processar('ontem');

function processar(modo) {
    if(!baseT.length) return alert("Carregue a planilha de TURNO!");
    
    const area = document.getElementById('renderArea');
    const setT = new Set();
    const setS = new Set();
    const chaves = Object.keys(EQUIPES).sort();

    // LÃ³gica de IdentificaÃ§Ã£o por Coluna "Equipe"
    baseT.forEach(r => {
        for(let key in r) {
            if(key.toLowerCase().trim() === 'equipe') {
                const val = String(r[key]).toUpperCase().trim();
                if(EQUIPES[val]) setT.add(val);
            }
        }
    });

    if(modo === 'hoje') {
        document.getElementById('tituloRel').innerText = "RELAÃ‡ÃƒO EQUIPES COM TURNO ABERTO";
        document.getElementById('dataTxt').innerText = new Date().toLocaleDateString('pt-BR');
        const abertas = chaves.filter(k => setT.has(k));
        const faltam = chaves.filter(k => !setT.has(k));
        area.innerHTML = desenhar("âœ… TURNOS ABERTOS HOJE", abertas, "bg-verde", "ABERTO", "#2e7d32") +
                         desenhar("ðŸŸ  TURNOS NÃƒO ABERTOS", faltam, "bg-laranja", "PENDENTE", "#ef6c00");
    } else {
        if(!baseS.length) return alert("Carregue a planilha de SERVIÃ‡OS para o RDO!");
        document.getElementById('tituloRel').innerText = "RELAÃ‡ÃƒO EQUIPES QUE ABRIRAM O TURNO MAS SEM APONTAMENTO (RDO)";
        const ontem = new Date(); ontem.setDate(ontem.getDate() - 1);
        document.getElementById('dataTxt').innerText = ontem.toLocaleDateString('pt-BR');

        baseS.forEach(r => {
            for(let key in r) {
                if(key.toLowerCase().trim() === 'equipe') {
                    const val = String(r[key]).toUpperCase().trim();
                    if(EQUIPES[val]) setS.add(val);
                }
            }
        });

        const erro = chaves.filter(k => setT.has(k) && !setS.has(k));
        const ok = chaves.filter(k => setT.has(k) && setS.has(k));
        const off = chaves.filter(k => !setT.has(k));

        area.innerHTML = desenhar("ðŸ”´ ALERTA:TURNO ABERTO MAS SEM APONTAMENTO (RDO)", erro, "bg-vermelho", "SEM APONTAMENTO(RDO)", "#c62828") +
                         desenhar("âœ… TURNO E RDO OK", ok, "bg-verde", "OK", "#2e7d32") +
                         desenhar("ðŸŸ  EQUIPES SEM TURNO", off, "bg-laranja", "FECHADO", "#ef6c00");
    }
    document.getElementById('btnPng').disabled = false;
    document.getElementById('btnPng').style.opacity = "1";
}

function desenhar(t, l, c, b, cor) {
    if(!l.length) return "";
    const cards = l.map(k => `<div class="card ${c}"><span>${k}</span><span class="badge" style="background:${cor}">${b}</span></div>`).join('');
    return `<div class="section-title"><span>${t}</span> <span>${l.length}</span></div><div class="grid">${cards}</div>`;
}

// FUNÃ‡ÃƒO DE DOWNLOAD CORRIGIDA
document.getElementById('btnPng').onclick = function() {
    const btn = this;
    btn.innerText = "GERANDO...";
    
    // Pequeno delay para garantir que o CSS foi aplicado
    setTimeout(() => {
        html2canvas(document.getElementById('printArea'), {
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: "#ffffff"
        }).then(canvas => {
            const image = canvas.toDataURL("image/png");
            const link = document.createElement('a');
            const dataStr = document.getElementById('dataTxt').innerText.replace(/\//g, '-');
            
            link.href = image;
            link.download = `RDO_OPERACIONAL_${dataStr}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            btn.innerText = "ðŸ“¸ BAIXAR PNG";
        }).catch(err => {
            alert("Erro ao gerar imagem. Tente novamente.");
            btn.innerText = "ðŸ“¸ BAIXAR PNG";
        });
    }, 500);
};
</script>
</body>
</html>