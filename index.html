<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDO, TURNO E APR: GPM MariuÃ¡</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", sans-serif; background: #1a1a1a; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; }
        .admin-panel { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        
        .upload-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .file-label { background: #444; color: white; padding: 12px; border-radius: 8px; cursor: pointer; display: block; font-weight: bold; font-size: 12px; transition: 0.3s; }
        .file-label:hover { background: #666; }
        input[type="file"] { display: none; }
        .status-txt { font-size: 11px; color: #888; margin-top: 5px; display: block; }

        .btn-group { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; padding-top: 15px; border-top: 1px solid #eee; }
        .btn { padding: 14px 22px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; text-transform: uppercase; color: white; transition: 0.2s; }
        .btn-turno { background: #2e7d32; }
        .btn-rdo { background: #1565c0; }
        .btn-apr { background: #7b1fa2; }
        .btn-png { background: #333; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .report-area { background: white; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .report-header { background: #00b7ab; color: white; padding: 25px; text-align: center; border-bottom: 6px solid #ffc107; }
        .report-body { padding: 25px; min-height: 400px; }
        
        .section-title { margin: 20px 0 10px; padding: 8px 12px; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; font-weight: bold; color: #555; background: #f9f9f9; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; }
        .card { padding: 12px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 11px; font-weight: bold; border: 1px solid #eee; }
        
        .bg-verde { background: #e8f5e9; border-left: 8px solid #2e7d32; color: #1b5e20; }
        .bg-laranja { background: #fff3e0; border-left: 8px solid #ef6c00; color: #e65100; }
        .bg-vermelho { background: #ffebee; border-left: 8px solid #c62828; color: #b71c1c; }
        .bg-roxo { background: #f3e5f5; border-left: 8px solid #7b1fa2; color: #4a148c; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 9px; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="container">
    <div class="admin-panel">
        <div class="upload-row">
            <div>
                <label class="file-label" for="fT">ðŸ“‚ TURNO (.xlsx)</label>
                <input type="file" id="fT" accept=".xlsx">
                <span id="sT" class="status-txt">Pendente</span>
            </div>
            <div>
                <label class="file-label" for="fS" style="background: #1565c0;">ðŸ“‚ RDO (.xlsx)</label>
                <input type="file" id="fS" accept=".xlsx">
                <span id="sS" class="status-txt">Pendente</span>
            </div>
            <div>
                <label class="file-label" for="fA" style="background: #7b1fa2;">ðŸ“‚ APR (.xlsx)</label>
                <input type="file" id="fA" accept=".xlsx">
                <span id="sA" class="status-txt">Pendente</span>
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-turno" onclick="processar('turno')">TURNO HOJE</button>
            <button class="btn btn-rdo" onclick="processar('rdo')">RDO ONTEM</button>
            <button class="btn btn-apr" onclick="processar('apr')">APR ONTEM</button>
            <button class="btn btn-png" id="btnPng" disabled onclick="baixarPNG()">ðŸ“¸ BAIXAR PNG</button>
        </div>
    </div>

    <div class="report-area" id="printArea">
        <div class="report-header">
            <h1 id="tituloRel">SISTEMA DE GESTÃƒO OPERACIONAL</h1>
            <p>DATA: <span id="dataTxt">--/--/----</span> Hora: <span id="horaTxt">--:--</span></p>
        </div>
        <div class="report-body" id="renderArea">
            <p style="text-align:center; color:#999; margin-top:100px;">Carregue as planilhas para gerar os indicadores.</p>
        </div>
    </div>
</div>
<script>
// --- NOVO: FunÃ§Ã£o para atualizar o relÃ³gio em tempo real ---
function atualizarRelogio() {
    const agora = new Date();
    const hora = String(agora.getHours()).padStart(2, '0');
    const minuto = String(agora.getMinutes()).padStart(2, '0');
    const segundo = String(agora.getSeconds()).padStart(2, '0');
    const horaFormatada = `${hora}:${minuto}:${segundo}`;
    
    const elementoHora = document.getElementById('horaTxt');
    if (elementoHora) {
        elementoHora.innerText = horaFormatada;
    }
}
// Inicia o relÃ³gio e atualiza a cada 1 segundo
setInterval(atualizarRelogio, 1000);
window.onload = atualizarRelogio; 
// ---------------------------------------------------------

const EQUIPES = [
    "ALAN-IRC", "ALEX-IRC", "EDILSON-IRC", "EDMILSON-IRC", "ELIEZER-IRC", "ENES-IRC", "ESMERALDO-IRC", 
    "FELIPE-IRC", "GABRIEL-IRC", "GIORLAN-IRC", "IRISMAR-IRC", "JAILSON-IRC", "JARBAS-IRC", "MARCOS-IRC", 
    "MENEZES-IRC", "REVERTON-IRC", "RIAN-IRC", "ROMERO-IRC", "UBERDAN-IRC", "VANILSON-IRC", "WASHINGTON-IRC", 
    "WESLEY-IRC", "WILIAN-IRC", "ANDRE-JAC", "CAIQUE-JAC", "CARLOS-JAC", "CLEBSON-JAC", "DIOGO-JAC", 
    "DOUGLAS-JAC", "EMERSON-JAC", "FABIANO-JAC", "GERALDO-JAC", "JAILTON-JAC", "JAIR-JAC", "JOAO-JAC", 
    "JULIO-JAC", "LUCIANO-JAC", "PATRICIO-JAC", "RODRIGO-JAC", "TIAGO-JAC", "VALMIR-JAC"
].sort();

let db = { turno: [], rdo: [], apr: [] };

function leitor(idIn, idSt, key) {
    document.getElementById(idIn).onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => {
            db[key] = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(ev.target.result), {type: 'array'}).Sheets[XLSX.read(new Uint8Array(ev.target.result), {type: 'array'}).SheetNames[0]]);
            document.getElementById(idSt).innerText = "âœ… Carregado";
            document.getElementById(idSt).style.color = "green";
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };
}
leitor('fT', 'sT', 'turno'); leitor('fS', 'sS', 'rdo'); leitor('fA', 'sA', 'apr');

function extrairEquipes(data) {
    const s = new Set();
    data.forEach(row => {
        for(let k in row) {
            if(k.toLowerCase().includes('equipe')) {
                const v = String(row[k]).toUpperCase().trim();
                if(EQUIPES.includes(v)) s.add(v);
            }
        }
    });
    return s;
}

function processar(modo) {
    if(!db.turno.length) return alert("Planilha de TURNO Ã© obrigatÃ³ria!");
    const area = document.getElementById('renderArea');
    const setT = extrairEquipes(db.turno);
    
    let html = "";
    let dataLabel = new Date().toLocaleDateString('pt-BR');

    if(modo === 'turno') {
        document.getElementById('tituloRel').innerText = "STATUS DE TURNO (HOJE)";
        const abertos = EQUIPES.filter(e => setT.has(e));
        const pendentes = EQUIPES.filter(e => !setT.has(e));
        html = desenhar("âœ… TURNOS ABERTOS", abertos, "bg-verde", "ABERTO", "#2e7d32") +
               desenhar("ðŸŸ  TURNOS NÃƒO ABERTOS", pendentes, "bg-laranja", "PENDENTE", "#ef6c00");
    } 
    else if(modo === 'rdo') {
        if(!db.rdo.length) return alert("Carregue a planilha de RDO!");
        document.getElementById('tituloRel').innerText = "APONTAMENTO DE RDO (ONTEM)";
        const ontem = new Date(); ontem.setDate(ontem.getDate()-1); dataLabel = ontem.toLocaleDateString('pt-BR');
        const setR = extrairEquipes(db.rdo);

        const erro = EQUIPES.filter(e => setT.has(e) && !setR.has(e));
        const ok = EQUIPES.filter(e => setT.has(e) && setR.has(e));
        const off = EQUIPES.filter(e => !setT.has(e));

        html = desenhar("ðŸ”´ ALERTA: TURNO ABERTO MAS SEM APONTAR O RDO", erro, "bg-vermelho", "FALTA RDO", "#c62828") +
               desenhar("âœ… RDO REALIZADO", ok, "bg-verde", "OK", "#2e7d32") +
               desenhar("ðŸŸ  EQUIPES SEM ABRIR TURNO ", off, "bg-laranja", "SEM TURNO", "#ef6c00");
    }
    else if(modo === 'apr') {
        if(!db.apr.length) return alert("Carregue a planilha de APR!");
        document.getElementById('tituloRel').innerText = "PREENCHIMENTO DA APR (ONTEM)";
        const ontem = new Date(); ontem.setDate(ontem.getDate()-1); dataLabel = ontem.toLocaleDateString('pt-BR');
        const setA = extrairEquipes(db.apr);

        const erro = EQUIPES.filter(e => setT.has(e) && !setA.has(e));
        const ok = EQUIPES.filter(e => setT.has(e) && setA.has(e));
        const off = EQUIPES.filter(e => !setT.has(e));

        html = desenhar("ðŸŸ£ ALERTA: TURNO ABERTO MAS SEM REALIZAR APR", erro, "bg-roxo", "FALTA APR", "#7b1fa2") +
               desenhar("âœ… APR ENVIADA", ok, "bg-verde", "OK", "#2e7d32") +
               desenhar("ðŸŸ  EQUIPES SEM ABRIR TURNO", off, "bg-laranja", "SEM TURNO", "#ef6c00");
    }

    document.getElementById('dataTxt').innerText = dataLabel;
    area.innerHTML = html;
    document.getElementById('btnPng').disabled = false;
}

function desenhar(t, l, c, b, cor) {
    if(!l.length) return "";
    const cards = l.map(k => `<div class="card ${c}"><span>${k}</span><span class="badge" style="background:${cor}">${b}</span></div>`).join('');
    return `<div class="section-title"><span>${t}</span> <span>${l.length}</span></div><div class="grid">${cards}</div>`;
}

function baixarPNG() {
    const btn = document.getElementById('btnPng');
    btn.innerText = "GERANDO...";
    html2canvas(document.getElementById('printArea'), { scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        link.download = `RELATORIO_${document.getElementById('dataTxt').innerText.replace(/\//g,'-')}.png`;
        link.href = canvas.toDataURL();
        link.click();
        btn.innerText = "ðŸ“¸ BAIXAR PNG";
    });
}
</script>
</body>
</html>