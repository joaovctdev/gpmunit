<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA GEST√ÉO: GPM Mariu√°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: #121212; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Painel de Controle */
        .admin-panel { background: #fff; padding: 25px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .upload-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .file-box { position: relative; }
        .file-label { background: #333; color: white; padding: 15px; border-radius: 8px; cursor: pointer; display: block; font-weight: bold; font-size: 12px; transition: 0.3s; border: 2px solid transparent; }
        .file-label:hover { background: #555; border-color: #00b7ab; }
        input[type="file"] { display: none; }
        .status-txt { font-size: 11px; color: #888; margin-top: 8px; display: block; font-style: italic; }

        /* Bot√µes */
        .btn-group { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; padding-top: 20px; border-top: 1px solid #eee; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 11px; text-transform: uppercase; color: white; transition: 0.2s; min-width: 140px; }
        .btn-hoje { background: #27ae60; } /* Verde */
        .btn-ontem { background: #2980b9; } /* Azul */
        .btn-m-turno { background: #e67e22; } /* Laranja */
        .btn-m-apr { background: #8e44ad; } /* Roxo */
        .btn-m-rdo { background: #c0392b; } /* Vermelho */
        .btn-png { background: #2c3e50; width: 100%; margin-top: 15px; font-size: 14px; }
        .btn:hover { opacity: 0.8; transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        /* Relat√≥rio Area */
        .report-area { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .report-header { background: #00b7ab; color: white; padding: 30px; text-align: center; border-bottom: 8px solid #ffc107; }
        .report-header h1 { font-size: 24px; letter-spacing: 1px; }
        .report-body { padding: 30px; min-height: 500px; background: #fff; }
        
        /* Estilos dos Cards e Se√ß√µes */
        .section-title { margin: 25px 0 15px; padding: 12px; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; font-weight: bold; color: #444; background: #f8f9fa; border-radius: 4px; font-size: 14px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
        .card { padding: 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; font-weight: bold; border: 1px solid #eee; transition: 0.3s; }
        
        /* Cores de Farol */
        .bg-verde { background: #e8f5e9; border-left: 8px solid #2e7d32; color: #1b5e20; }
        .bg-laranja { background: #fff3e0; border-left: 8px solid #ef6c00; color: #e65100; }
        .bg-vermelho { background: #ffebee; border-left: 8px solid #c62828; color: #b71c1c; }
        .bg-azul { background: #e3f2fd; border-left: 8px solid #1565c0; color: #0d47a1; }
        .bg-roxo { background: #f3e5f5; border-left: 8px solid #7b1fa2; color: #4a148c; }
        
        .badge { padding: 5px 10px; border-radius: 4px; color: white; font-size: 10px; text-transform: uppercase; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="container">
    <div class="admin-panel">
        <div class="upload-row">
            <div class="file-box">
                <label class="file-label" for="fT">üìÇ PLANILHA TURNO</label>
                <input type="file" id="fT" accept=".xlsx, .csv">
                <span id="sT" class="status-txt">Aguardando arquivo...</span>
            </div>
            <div class="file-box">
                <label class="file-label" for="fS" style="background: #1565c0;">üìÇ PLANILHA RDO</label>
                <input type="file" id="fS" accept=".xlsx, .csv">
                <span id="sS" class="status-txt">Aguardando arquivo...</span>
            </div>
            <div class="file-box">
                <label class="file-label" for="fA" style="background: #7b1fa2;">üìÇ PLANILHA APR</label>
                <input type="file" id="fA" accept=".xlsx, .csv">
                <span id="sA" class="status-txt">Aguardando arquivo...</span>
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn btn-hoje" onclick="processar('turno-hoje')">Turno Hoje</button>
            <button class="btn btn-ontem" onclick="processar('rdo-ontem')">RDO Ontem</button>
            <button class="btn btn-ontem" style="background:#6a1b9a" onclick="processar('apr-ontem')">APR Ontem</button>
            <button class="btn btn-m-turno" onclick="processar('mensal-turno')">üìä Turno Mensal</button>
            <button class="btn btn-m-apr" onclick="processar('mensal-apr')">üìù APR Mensal</button>
            <button class="btn btn-m-rdo" onclick="processar('mensal-rdo')">üìë RDO Mensal</button>
            <button class="btn btn-png" id="btnPng" disabled onclick="baixarPNG()">üì∏ DESCARREGAR RELAT√ìRIO EM PNG</button>
        </div>
    </div>

    <div class="report-area" id="printArea">
        <div class="report-header">
            <h1 id="tituloRel">PAINEL DE INDICADORES OPERACIONAIS</h1>
            <p>DATA: <span id="dataTxt">--/--/----</span> | GPM MARIU√Å</p>
        </div>
        <div class="report-body" id="renderArea">
            <div style="text-align:center; padding-top:100px;">
                <img src="https://cdn-icons-png.flaticon.com/512/1243/1243420.png" width="80" style="opacity:0.2"><br><br>
                <p style="color:#999; font-weight:bold;">Selecione os arquivos acima e clique em um indicador.</p>
            </div>
        </div>
    </div>
</div>

<script>
// Lista de Equipes Padronizada
const EQUIPES = ["ALAN-IRC", "ALEX-IRC", "EDILSON-IRC", "EDMILSON-IRC", "ELIEZER-IRC", "ENES-IRC", "ESMERALDO-IRC", "FELIPE-IRC", "GABRIEL-IRC", "GIORLAN-IRC", "IRISMAR-IRC", "JAILSON-IRC", "JARBAS-IRC", "MARCOS-IRC", "MENEZES-IRC", "REVERTON-IRC", "RIAN-IRC", "ROMERO-IRC", "UBERDAN-IRC", "VANILSON-IRC", "WASHINGTON-IRC", "WESLEY-IRC", "WILIAN-IRC", "ANDRE-JAC", "CAIQUE-JAC", "CARLOS-JAC", "CLEBSON-JAC", "DIOGO-JAC", "DOUGLAS-JAC", "EMERSON-JAC", "FABIANO-JAC", "GERALDO-JAC", "JAILTON-JAC", "JAIR-JAC", "JOAO-JAC", "JULIO-JAC", "LUCIANO-JAC", "PATRICIO-JAC", "RODRIGO-JAC", "TIAGO-JAC", "VALMIR-JAC"].sort();

let db = { turno: [], rdo: [], apr: [] };

// Fun√ß√£o de leitura de arquivos (Suporta Excel e CSV)
function configurarLeitor(idInput, idStatus, chave) {
    document.getElementById(idInput).onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = ev => {
            try {
                const data = new Uint8Array(ev.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                db[chave] = XLSX.utils.sheet_to_json(sheet, { defval: "" });
                document.getElementById(idStatus).innerText = "‚úÖ Arquivo Carregado";
                document.getElementById(idStatus).style.color = "#27ae60";
            } catch (err) {
                alert("Erro ao ler arquivo. Verifique se √© um Excel ou CSV v√°lido.");
            }
        };
        reader.readAsArrayBuffer(file);
    };
}

configurarLeitor('fT', 'sT', 'turno');
configurarLeitor('fS', 'sS', 'rdo');
configurarLeitor('fA', 'sA', 'apr');

// Fun√ß√£o auxiliar para encontrar colunas (busca flex√≠vel)
function buscarValor(obj, termos) {
    for (let k in obj) {
        let keyNormalized = k.toLowerCase().replace(/_/g, '').trim();
        if (termos.some(t => keyNormalized.includes(t))) return String(obj[k]).trim();
    }
    return "";
}

function processar(modo) {
    const area = document.getElementById('renderArea');
    const mesAtual = new Date().getMonth();
    const anoAtual = new Date().getFullYear();
    let html = "";

    // 1. TURNO HOJE (Presen√ßa di√°ria)
    if (modo === 'turno-hoje') {
        if(!db.turno.length) return alert("Carregue a planilha de TURNO!");
        document.getElementById('tituloRel').innerText = "STATUS DE TURNO: HOJE";
        let ativos = new Set();
        db.turno.forEach(row => {
            let eq = buscarValor(row, ['equipe', 'desequipe']);
            if(EQUIPES.includes(eq.toUpperCase())) ativos.add(eq.toUpperCase());
        });
        const listaAtivos = EQUIPES.filter(e => ativos.has(e));
        const listaFalta = EQUIPES.filter(e => !ativos.has(e));
        html = desenharSecao("‚úÖ TURNOS ABERTOS", listaAtivos, "bg-verde", "ABERTO", "#2e7d32") +
               desenharSecao("üü† AGUARDANDO ABERTURA", listaFalta, "bg-laranja", "PENDENTE", "#ef6c00");
    }

    // 2. RDO ONTEM (Cruzamento Turno x RDO)
    else if (modo === 'rdo-ontem') {
        if(!db.turno.length || !db.rdo.length) return alert("Carregue TURNO e RDO!");
        document.getElementById('tituloRel').innerText = "CONFORMIDADE RDO: ONTEM";
        let ativosTurno = new Set();
        let ativosRdo = new Set();
        db.turno.forEach(row => { let e = buscarValor(row, ['equipe']); if(e) ativosTurno.add(e.toUpperCase()); });
        db.rdo.forEach(row => { let e = buscarValor(row, ['equipe', 'codequipe']); if(e) ativosRdo.add(e.toUpperCase()); });
        
        const ok = EQUIPES.filter(e => ativosTurno.has(e) && ativosRdo.has(e));
        const erro = EQUIPES.filter(e => ativosTurno.has(e) && !ativosRdo.has(e));
        html = desenharSecao("‚úÖ RDO LAN√áADO", ok, "bg-verde", "OK", "#2e7d32") +
               desenharSecao("üî¥ FALTA LAN√áAR RDO", erro, "bg-vermelho", "PENDENTE", "#c62828");
    }

    // 3. APR ONTEM (Cruzamento Turno x APR)
    else if (modo === 'apr-ontem') {
        if(!db.turno.length || !db.apr.length) return alert("Carregue TURNO e APR!");
        document.getElementById('tituloRel').innerText = "CONFORMIDADE APR: ONTEM";
        let ativosTurno = new Set();
        let ativosApr = new Set();
        db.turno.forEach(row => { let e = buscarValor(row, ['equipe']); if(e) ativosTurno.add(e.toUpperCase()); });
        db.apr.forEach(row => { let e = buscarValor(row, ['equipe']); if(e) ativosApr.add(e.toUpperCase()); });
        
        const ok = EQUIPES.filter(e => ativosTurno.has(e) && ativosApr.has(e));
        const erro = EQUIPES.filter(e => ativosTurno.has(e) && !ativosApr.has(e));
        html = desenharSecao("‚úÖ APR ENVIADA", ok, "bg-verde", "OK", "#2e7d32") +
               desenharSecao("üü£ FALTA ENVIAR APR", erro, "bg-roxo", "PENDENTE", "#7b1fa2");
    }

    // 4. MENSAL TURNO (Contagem de dias √∫nicos)
    else if (modo === 'mensal-turno') {
        document.getElementById('tituloRel').innerText = "MENSAL: DIAS TRABALHADOS (TURNO)";
        let diasEq = {}; EQUIPES.forEach(e => diasEq[e] = new Set());
        db.turno.forEach(row => {
            let eq = buscarValor(row, ['equipe']).toUpperCase();
            let dt = buscarValor(row, ['data', 'inicio']);
            if(EQUIPES.includes(eq) && dt) {
                let p = dt.split(' ')[0].split('/');
                if(p.length === 3) {
                    let d = new Date(p[2], p[1]-1, p[0]);
                    if(d.getMonth() === mesAtual) diasEq[eq].add(dt.split(' ')[0]);
                }
            }
        });
        const dados = EQUIPES.map(e => [e, diasEq[e].size]).sort((a,b) => b[1] - a[1]);
        html = desenharMensal("RANKING DE PRESEN√áA NO M√äS", dados, "DIAS", "turno");
    }

    // 5. MENSAL APR (Soma total independente do dia)
    else if (modo === 'mensal-apr') {
        document.getElementById('tituloRel').innerText = "MENSAL: VOLUME DE APRs ENVIADAS";
        let totalApr = {}; EQUIPES.forEach(e => totalApr[e] = 0);
        db.apr.forEach(row => {
            let eq = buscarValor(row, ['equipe']).toUpperCase();
            let dt = buscarValor(row, ['data', 'cadastro']);
            if(EQUIPES.includes(eq) && dt) {
                let p = dt.split(' ')[0].split('/');
                if(p.length === 3 && new Date(p[2], p[1]-1, p[0]).getMonth() === mesAtual) totalApr[eq]++;
            }
        });
        const dados = EQUIPES.map(e => [e, totalApr[e]]).sort((a,b) => b[1] - a[1]);
        html = desenharMensal("TOTAL DE APRs ACUMULADAS", dados, "APRs", "apr");
    }

    // 6. MENSAL RDO (Soma total com filtro 07:30)
    else if (modo === 'mensal-rdo') {
        document.getElementById('tituloRel').innerText = "MENSAL: VOLUME DE RDOs (PRODU√á√ÉO)";
        let totalRdo = {}; EQUIPES.forEach(e => totalRdo[e] = 0);
        db.rdo.forEach(row => {
            let eq = buscarValor(row, ['equipe', 'codequipe']).toUpperCase();
            let dt = buscarValor(row, ['datainicio', 'inicio']);
            if(EQUIPES.includes(eq) && dt) {
                if(dt.includes("07:30")) return; // FILTRO 07:30
                let p = dt.split(' ')[0].split('/');
                if(p.length === 3 && new Date(p[2], p[1]-1, p[0]).getMonth() === mesAtual) totalRdo[eq]++;
            }
        });
        const dados = EQUIPES.map(e => [e, totalRdo[e]]).sort((a,b) => b[1] - a[1]);
        html = desenharMensal("TOTAL DE RDOs (EXCLUINDO HORA MORTA)", dados, "RDOs", "apr");
    }

    area.innerHTML = html;
    document.getElementById('dataTxt').innerText = new Date().toLocaleDateString();
    document.getElementById('btnPng').disabled = false;
}

function desenharSecao(titulo, lista, corClasse, badgeTxt, badgeCor) {
    if(!lista.length) return "";
    const cards = lista.map(nome => `<div class="card ${corClasse}"><span>${nome}</span><span class="badge" style="background:${badgeCor}">${badgeTxt}</span></div>`).join('');
    return `<div class="section-title"><span>${titulo}</span> <span>${lista.length}</span></div><div class="grid">${cards}</div>`;
}

function desenharMensal(titulo, dados, sufixo, tipo) {
    const cards = dados.map(([eq, qtd]) => {
        let cor = "bg-verde"; let bCol = "#2e7d32";
        if(tipo === 'apr') { // L√≥gica APR/RDO: <3 Vermelho, <10 Laranja
            if(qtd < 3) { cor = "bg-vermelho"; bCol = "#c62828"; }
            else if(qtd < 10) { cor = "bg-laranja"; bCol = "#ef6c00"; }
        } else { // L√≥gica Turno: <=10 Vermelho, <=15 Laranja
            if(qtd <= 10) { cor = "bg-vermelho"; bCol = "#c62828"; }
            else if(qtd <= 15) { cor = "bg-laranja"; bCol = "#ef6c00"; }
        }
        return `<div class="card ${cor}"><span>${eq}</span><span class="badge" style="background:${bCol}">${qtd} ${sufixo}</span></div>`;
    }).join('');
    return `<div class="section-title"><span>${titulo}</span> <span>${dados.length} EQUIPES</span></div><div class="grid">${cards}</div>`;
}

function baixarPNG() {
    html2canvas(document.getElementById('printArea'), { scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        link.download = `RELATORIO_OPERACIONAL_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL();
        link.click();
    });
}
</script>
</body>
</html>